<!--
    Created by yun on 2/10/16.
    Author:yun
-->
<html>
<head>
    <script type="text/javascript" src="{{ url_for('static', filename='vis/dist/vis.js') }}"></script>
    <script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='Network.js') }}"></script>
    <link href="{{ url_for('static', filename='vis/dist/vis.css') }}" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet">



    <style type="text/css">
        #mynetwork {
            width: 1200px;
            height: 610px;
            border: 1px solid lightgray;
            margin-top: 10px;
            margin-left: 40px;
            margin-right: 10px;
            border-radius: 10px;
            float: left;
        }
        .navi-header{
    /*transition:all ease-in-out 0.3s;*/
    font-family: 'IM Fell French Canon SC', serif;
    height: 60px;
    background: rgba(255,255,255,0.97);
    opacity: 0.93;
    padding: 0;
    z-index: 9;
    width: 100%;
    border-bottom: 1px solid #E2E2E2;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1),0 0 0 1px rgba(0, 0, 0, 0.05);
}
.navi-header a{
    color:#66615b;
    font-size: 14px;
    text-decoration: none;
}
.navi-inner{
    width: 1300px;
    text-align: left;
    height: 68px;
    margin: 0 auto;
    padding: 0;
        }
.navi-logo{
    float: left;
    width:125px;
    margin-left: 65px;
    margin-top: 18px;
    margin-right: 10px;
    height:60px;
}
.navi-logo a{
    font-family: 'Kavoon', cursive;
    font-size: 20px;
    color: #D15600;
    margin-left: -15px;
}

.navi-entry{
   float: right;
   margin: auto  0;
   margin-right: 30px;
   height: 80px;
}
.navi-entry li {
 display: inline-block;
 margin:  28px 20px 24px 20px;
}
.hideblock{
    display: none;
}
.button-box{
    float: left;
    margin-left: 20px;
    margin-top:50px;
}

        .blockbox{
            margin-top: 50px;
            margin-bottom:100px;
        }
        .btn{
			padding: 4px 8px;
			display: inline-block;
            margin-top: 5px;
		}
		.btn-primary2{
		  background: #ebebeb;
		  color: #888;
		  border: none;
		  text-shadow: -1px -1px 2px #f8f8f8;
		}
		.btn-primary{
            width: 110px;
            height: 30px;
            margin-top: 10px;
		  color: #fff;
			background: -webkit-linear-gradient(top, #98d0e0 2%, #68b8d1 8%, #4fa9c6 58%, #4fa9c6 95%, #4ca4c0);
			border: 0;
			font-weight: 200;
			border-radius: 3px;
			text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.15);
		}
		.btn-primary:hover{
		  color: #fff;
		  background:#68B5CB;
		  border: 0;
		}

	      .select-container{
	      	font-family: "Hiragino Sans GB","Microsoft YaHei","微软雅黑",tahoma,arial,simsun,"宋体" !important;
			color:#555;
			font-size: 13px;
			width: 110px;
              margin: auto;
		}


		.select-container .select {
		  border-radius: 3px;
		  border: 1px solid #ccc;
		  background-color: white;
		  margin-top: 10px;
		}


		.select__options {
		  display: none;
		  list-style-type: none;
		  border-top: 1px solid #ccc;
		    margin-bottom: 0;
		    margin-top: 0;
		    padding: 0;
		}
		.select__options li {
		  padding: 1px 10px;
		  margin: 0 ;
		  line-height: 0.1;
		}
		.select__options li:hover, .select__options li:focus {
		  background-color: #98d0e0;
		  color: white;
		}

		.select-is-open {
		  z-index: 9999;
		}
		.select-is-open .select {
		  box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
		}
		.select-is-open .select__options {
		  display: block;
		}
		.select-container .form-control{
			outline: none;
			font-family: "Hiragino Sans GB","Microsoft YaHei","微软雅黑",tahoma,arial,simsun,"宋体" !important;
			display: block;
			width: 75%;
			height: 30px;
			padding: 4px 2px;
			padding-left: 8px;
			font-size: 13px;
			line-height: 1.4285;
			color:#555;
			background: #fff;
			background-image: none;
			transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
		}
        .select-container .checkOrNotLabel{
            margin-left: 4px;
        }
    </style>
</head>
<body>
<div id="navi-header" class="navi-header ">
	<div class="navi-inner">
		<div id="navi-logo" class="navi-logo">
             <a href="##">Tree Network</a>
		</div>

		<ul class="navi-entry">
            <li class="entry-home-li">

                <a href="##" class="entry-home">
					<span class="home-icon">
					</span>
					<span class="home-text">{{ session.username }}</span>
				</a>
			</li>
			<li class="entry-signout-li">
				<a href="{{ url_for("index.logout") }}" class="entry-signout">
					<span class="signout-icon"></span>
					<span class="signout-text">SignOut</span>
				</a>
			</li>
		</ul>

	</div>
</div>

<div class="changeInformationBox">
    <ul class="">

    </ul>
</div>

<div id="mynetwork" class="mywork"></div>
<div class="button-box">
    <div class="blockbox">
        <div class="select-container">
                <div class="select">
                     <i  name="select-btn" style="float:right;margin-top: 5px;margin-right: 2px;font-size: 20px;cursor: pointer;color:#555;" class="material-icons" onselectstart="return false;">add</i>
                    <input readonly="value" class="form-control post-question" id="connectorSelectBox" type="text"  style="border: 0;">
                     <ul class="select__options">
                    </ul>
                </div>
    	</div>
         <button  type="submit" id="richtext-submit" class="btn btn-primary addConnectorNodeBtn" style="font-size: 16px;">add pattern</button>
    </div>
    <div class="blockbox">
        <div class="select-container">
                <div class="select">
                     <i  name="select-btn" style="float:right;margin-top: 5px;margin-right: 2px;font-size: 20px;cursor: pointer;color:#555;" class="material-icons" onselectstart="return false;">add</i>
                    <input readonly="value" class="form-control post-question" id="normalSelect" type="text"  style="border: 0;">
                     <ul class="select__options">
                    </ul>
                </div>
    	</div>
        <div class="select-container hideblock">
                <div class="select">
                     <i  name="select-btn" style="float:right;margin-top: 5px;margin-right: 2px;font-size: 20px;cursor: pointer;color:#555;" class="material-icons" onselectstart="return false;">add</i>
                    <input readonly="value" class="form-control post-question" id="normalSelect2" type="text"  style="border: 0;">
                     <ul class="select__options">
                    </ul>
                </div>
    	</div>
        <button  type="submit" id="richtext-submit" class="btn btn-primary addNormalNodeBtn" style="font-size: 16px;">add node</button>
    </div>
        <div class="blockbox">
        <div class="select-container">
                <div class="select">
                     <i  name="select-btn" style="float:right;margin-top: 5px;margin-right: 2px;font-size: 20px;cursor: pointer;color:#555;" class="material-icons" onselectstart="return false;">add</i>
                    <input readonly="value" class="form-control post-question" id="deleteSelect" type="text"  style="border: 0;">
                     <ul class="select__options">
                    </ul>
                </div>
    	</div>
        <div class="select-container hideblock">
                <div class="select">
                     <i  name="select-btn" style="float:right;margin-top: 5px;margin-right: 2px;font-size: 20px;cursor: pointer;color:#555;" class="material-icons" onselectstart="return false;">add</i>
                    <input readonly="value" class="form-control post-question" id="deleteSelect2" type="text"  style="border: 0;">
                     <ul class="select__options">
                    </ul>
                </div>
    	</div>
        <button  type="submit" id="richtext-submit" class="btn btn-primary deleteNormalNodeBtn" style="font-size: 16px;">delete node</button>
    </div>
</div>
<pre id="eventSpan"></pre>


<script type="text/javascript">

        $('[name=select-btn]').click(function() {
            $(this).parent().parent().toggleClass('select-is-open');
        });

    var $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
    var networkPY;
    var networkTest;
    var dataStore;
    var options={
        nodes:{
            mass:0,
            size:10,
            scaling:{
                min:10,
                max:10,
                label:{
                    enabled:true,
                    min:10,
                    max:10
                }
            },
            value: 10,
            fixed: true,
            shapeProperties:{
                borderRadius: 1
            }
        },
        edges:{
        },
        physics:{
            enabled:false,
            stabilization:false
        },
        layout:{
            improvedLayout:false
        },
        interaction:{
            zoomView: false
        }
    };
    var container = document.getElementById('mynetwork');

    function startNetwork(data){
        networkPY= new NetworkYun.Network(JSON.parse(data.result1));
        var nodesDataGet= networkPY.getNodesData();
        var edgesDataGet = networkPY.getEdgesData();
        var nodes2TT = new vis.DataSet();
        var edges2TT = new vis.DataSet();
         nodes2TT.add(nodesDataGet);
        edges2TT.add(edgesDataGet);
         dataStore={
            nodes : nodes2TT,
            edges : edges2TT
         };
        networkTest = new vis.Network(container, dataStore,options);
        changeSelectBox();
        console.log(networkPY);
{#        networkTest.on("click", function (params) {#}
{#            params.event = "[original event]";#}
{#            document.getElementById('eventSpan').innerHTML = '<h2>Click event:</h2>' + JSON.stringify(params, null, 4);#}
{#        });#}
    }

    function  makeSelectBox(whichBox,whichBox2,addOrDeleted){
        whichBox.parent().find('.select__options li').bind('click',function(){
            whichBox.val($(this).find('p').text());
            $(this).parent().parent().parent().removeClass('select-is-open');
            whichBox2.next().children().each(function(){
                $(this).remove();
            });
            whichBox2.parent().parent().removeClass('hideblock');
            var whichPattern = networkPY.getPatternById(whichBox.val().substring(8));
            var contentL;
            if(addOrDeleted) contentL = whichPattern.getCanBeAdded();
            else contentL = whichPattern.getCanBeDeleted();
            for (var i in contentL){
                whichBox2.next().append("<li><p>node " + contentL[i] +"</p></li>");
            }
            whichBox2.parent().find('.select__options li').bind('click',function(){
                whichBox2.val($(this).find('p').text());
                $(this).parent().parent().parent().removeClass('select-is-open');
            });
            if(whichBox2.parent().find('.select__options li').length==0){
                whichBox2.val("Nothing");
            }
            else whichBox2.parent().find('.select__options li:nth-child(1)').click();
        });
        whichBox.parent().find('.select__options li').each(function(){
           if($(this).find('p').text()==whichBox.val()){
               $(this).click();
           }
        });
    }

    function  changeSelectBox(){
        $('.blockbox li').each(function(){
            $(this).remove();
        });
{#        $('#normalSelect').next().children().each(function(){#}
{#            $(this).remove();#}
{#        });#}
{#        $('#normalSelect2').next().children().each(function(){#}
{#                $(this).remove();#}
{#        });#}
        var patternData = networkPY.getPatternData();
        for(var i=0;i<patternData.length;i++){
             $('#normalSelect').next().append("<li ><p>pattern " +patternData[i].getId() +"</p></li>");
            $('#deleteSelect').next().append("<li ><p>pattern " +patternData[i].getId() +"</p></li>");
             $('#connectorSelectBox').next().append("<li><input name='checkOrNot' type='checkbox'>" +
                             "<label class='checkOrNotLabel' for='checkOrNot'>pattern " + patternData[i].getId() + "</label></li>");
        }
        $('#connectorSelectBox').parent().find('.select__options li').find('label').bind('click',function(){
           if($(this).prev().prop('checked')) $(this).prev().prop('checked',false);
           else  $(this).prev().prop('checked',true);
        });
        makeSelectBox($('#normalSelect'),$('#normalSelect2'),true);
        makeSelectBox($('#deleteSelect'),$('#deleteSelect2'),false);
    }


     $('.addConnectorNodeBtn').click(function () {
         var patternBoxs=[];
        $('#connectorSelectBox').next().find('input').each(function(){
            if($(this).is(':checked')) patternBoxs.push($(this).next().text().substring(8));
        });
         if(patternBoxs.length==0) return false;
         var whichNode = networkPY.ToBeAddedOnePattern();
         console.log(patternBoxs);
         $.getJSON($SCRIPT_ROOT + '/network/addPattern', {
                    a: JSON.stringify(patternBoxs),
                    b: JSON.stringify(whichNode)
                  }, function(data) {
                        var count1 = data.result1;
                        var count2 = data.result2;
                        whichNode.nid = count2;
                        whichNode.pid = count1;
                        console.log("fuck");
                        networkPY.addPattern(whichNode,patternBoxs);
                        changeSelectBox();
                  });
     });


    $('.addNormalNodeBtn').click(function () {
        if($('#normalSelect').val()=="Nothing"||$('#normalSelect').val()=="") return false;
        if($('#normalSelect2').val()=="Nothing"||$('#normalSelect2').val()=="") return false;
        var whichPatternId =  $('#normalSelect').val().substring(8);
        var whichParent = $('#normalSelect2').val().substring(5);
        var whichPattern = networkPY.getPatternById(whichPatternId);
        var whichOne = whichPattern.getCanBeAddedChild(whichParent);
        if(whichOne==-1) return false;
        var whichNode = whichPattern.ToBeAddedOne(whichParent,whichOne);
        $.getJSON($SCRIPT_ROOT + '/network/addNode', {
                    a: JSON.stringify(whichNode)
                  }, function(data) {
                        var i = data.result1;
                        whichNode.nid=i;
                        networkPY.addNode(whichPatternId,whichNode);
                        changeSelectBox();
                  });
     });

     $('.deleteNormalNodeBtn').click(function(){
         if($('#deleteSelect').val()=="Nothing"||$('#deleteSelect').val()=="") return false;
         if($('#deleteSelect2').val()=="Nothing"||$('#deleteSelect2').val()=="") return false;
         var whichPatternId =  $('#deleteSelect').val().substring(8);
         var whichOne = $('#deleteSelect2').val().substring(5);
         var returnList = networkPY.deleteNode(whichPatternId,whichOne);
         $.getJSON($SCRIPT_ROOT + '/network/deleteNode', {
                    a: JSON.stringify(returnList)
                  }, function(data) {
                        console.log("fuck");
                        var i = data.result1;
                        changeSelectBox();
                  });
     });


    $(document).ready(function($){
        setTimeout(function (){
            $.getJSON($SCRIPT_ROOT + '/network/whole_network', {
                    a: 1
                  }, function(data) {
                        startNetwork(data);
                  });
            }, 300);
    });

</script>
</body>
</html>
