<!--
    Created by yun on 2/10/16.
    Author:yun
-->
<html>
<head>
    <script type="text/javascript" src="{{ url_for('static', filename='vis.js') }}"></script>
    <script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='Network.js') }}"></script>
    <link href="{{ url_for('static', filename='vis.css') }}" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet">



    <style type="text/css">
        body{
            font-family: "Hiragino Sans GB","Microsoft YaHei","微软雅黑",tahoma,arial,simsun,"宋体" !important;
            color: #555;
            font-size: 13px;
            margin: 0;
            padding: 0;
        }
        button:focus{
            outline: none;
        }
        #mynetwork {
            width: 1200px;
            height: 610px;
            border: 1px solid lightgray;
            margin-top: 10px;
            margin-left: 40px;
            margin-right: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
            float: left;
        }
        .navi-header{
            /*transition:all ease-in-out 0.3s;*/
            font-family: 'IM Fell French Canon SC', serif;
            height: 60px;
            background: rgba(255,255,255,0.97);
            opacity: 0.93;
            padding: 0;
            z-index: 9;
            width: 100%;
            border-bottom: 1px solid #E2E2E2;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1),0 0 0 1px rgba(0, 0, 0, 0.05);
        }
        .navi-header a{
            color:#66615b;
            font-size: 14px;
            text-decoration: none;
        }
        .navi-inner{
            width: 1300px;
            text-align: left;
            height: 68px;
            margin: 0 auto;
            padding: 0;
                }
        .navi-logo{
            float: left;
            width:125px;
            margin-left: 65px;
            margin-top: 18px;
            margin-right: 10px;
            height:60px;
        }
        .navi-logo a{
            font-family: 'Kavoon', cursive;
            font-size: 20px;
            color: #D15600;
            margin-left: -15px;
        }

        .navi-entry{
           float: right;
           margin: auto  0;
           margin-right: 30px;
        }
        .navi-entry li {
         display: inline-block;
         margin:  28px 45px 24px 20px;
        }
        .hideblock{
            display: none;
        }
        .button-box{
            float: left;
            margin-left: 20px;
            margin-top: 25px;
        }

        .blockbox{
            margin-bottom:40px;
        }
        .btn{
			padding: 4px 8px;
			display: inline-block;
            margin-top: 5px;
		}
		.btn-primary2{
		  background: #ebebeb;
		  color: #888;
		  text-shadow: -1px -1px 2px #f8f8f8;
            width: 110px;
            height: 30px;
            border: none;
            border-radius: 4px;
		}
		.btn-primary{
            width: 110px;
            height: 30px;
            margin-top: 10px;
		  color: #fff;
			background: -webkit-linear-gradient(top, #98d0e0 2%, #68b8d1 8%, #4fa9c6 58%, #4fa9c6 95%, #4ca4c0);
			border: 0;
			font-weight: 200;
			border-radius: 3px;
			text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.15);
		}
		.btn-primary:hover{
		  color: #fff;
		  background:#68B5CB;
		  border: 0;
		}

	      .select-container{
	      	font-family: "Hiragino Sans GB","Microsoft YaHei","微软雅黑",tahoma,arial,simsun,"宋体" !important;
			color:#555;
			font-size: 13px;
			width: 110px;
              margin: auto;
		}


		.select-container .select {
		  border-radius: 3px;
		  border: 1px solid #ccc;
		  background-color: white;
		  margin-top: 10px;
		}


		.select__options {
		    display: none;
		    list-style-type: none;
		    border-top: 1px solid #ccc;
		    margin-bottom: 0;
		    margin-top: 0;
		    padding: 0;
		}
		.select__options li {
		    padding: 1px 6px;
		    margin: 0 ;
		    line-height: 0.1;
		}
		.select__options li:hover, .select__options li:focus {
		  background-color: #98d0e0;
		  color: white;
		}

		.select-is-open {
		  z-index: 9999;
		}
		.select-is-open .select {
		  box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
		}
		.select-is-open .select__options {
		  display: block;
		}
		.select-container .form-control{
			outline: none;
			font-family: "Hiragino Sans GB","Microsoft YaHei","微软雅黑",tahoma,arial,simsun,"宋体" !important;
			display: block;
			width: 75%;
			height: 30px;
			padding: 4px 2px;
			padding-left: 8px;
			font-size: 13px;
			line-height: 1.4285;
			color:#555;
			background: #fff;
			background-image: none;
			transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
		}
        .select-container .checkOrNotLabel{
            margin-left: 4px;
        }
        .Infbox li{
            padding: 3px 6px;
        }
        .Infbox{
            border-left: 1px solid #ccc;
            border-right: 1px solid #ccc;
            border-bottom: 1px solid #ccc;
            border-radius: 3px;
        }
        .Infbox a{
            outline: none;
            text-decoration:none;
            color:#66615b;
            font-size: 12px;
        }
        .changeIfmBox{
            width: 180px;
            margin-left: 1060px;
            position: fixed;
            background: white;
        }
        .button-box2{
            float: left;
            margin-left: 30px ;
        }
        .button-box2 .blockbox{
            margin-top: 0;
            margin-bottom: 5px;
        }
        .button-box2 .blockbox button{
            margin-right: 12px;
        }
        .messageInf{
            outline: none;
			font-family: "Hiragino Sans GB","Microsoft YaHei","微软雅黑",tahoma,arial,simsun,"宋体" !important;
			height: 35px;
            width: 200px;
			padding: 4px 2px;
			padding-left: 8px;
			font-size: 12px;
			line-height: 1.4285;
			color:#555;
			background: #fff;
			background-image: none;
			transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
            float: left;
            display: block;
            border: 1px solid #ccc;
            border-radius: 3px;
            margin-left: 15px;
            margin-top: 10px;
            margin-right: 10px;
            overflow-y:auto;
        }
        .bottom-container{
            float: left;
            margin-left: 10px;
        }
        .cover-black{
    	    opacity: 1;
	        position: fixed;
	        left: 0;
	        top: 0;
	        right: 0;
	        bottom: 0;
	        width: 100%;
	        height: 100%;
	        z-index: 4;
	        background-color: rgba(0, 0, 0, 0.75);
        }
        .messageBoxBlock{
            width: 45%;
            position: fixed;
            top:12%;
            left:25%;
            border: 2px solid #AEAEAE;
            padding: 20px 20px  0 20px;
            z-index: 5;
            opacity: 0;
            visibility: hidden;
            background: #fff;
            border-radius: 4px;
            height: 620px;
        }
        .messageBox-show{
            opacity: 1;
            visibility: visible;
        }
        .messageBox{
            margin-top: 5px;
            height: 515px;
            overflow-y:auto;
            scrollbar-face-color: #ebebeb;
            scrollbar-shadow-color: #ffffff;
            scrollbar-highlight-color:#ffffff;
            scrollbar-3dlight-color: #d8d8d8;
            scrollbar-darkshadow-color: #d8d8d8;
            scrollbar-track-color:#ffffff;
            scrollbar-arrow-color: #686868;
        }
        .messageBox li{
            line-height: 18px;
            padding: 2px 10px;
            padding-bottom: 20px;
        }
        .closeBox{
            width: 100%;
        }
        .closeMsgBtn{
            margin-left: 275px;
            margin-top: 10px;
        }
        #messagaBoxLab{
            font-size: 16px;
            color:#D15600;
            display: block;
            margin-left: 270px;
        }
        .messageList{
            display: block;
            padding-top: 10px;
        }
        .Msglabel{
            margin-right: 50px;
            display: inline-block;
            white-space: nowrap;
            color: #56AAC3 ;
            font-size: 12px;
        }
        .Msgtime{
            color:#ccc;
            margin-right: 35px;
            float: right;
        }
        .lastword{
            font-size: 11px;
            margin-left:-980px;
            color: #ccc;
        }
        #defaultSlider{
            width: 110px;
        }
        .btnBox{
            float: left;
        }
        .wordbox{
            margin-top: 39px;
        }
        .controler{
            margin-top: 15px;
            margin-left: 8px;
            font-size: 12px;
            color:black;
        }
        .controler label{
            padding: 8px 10px;
        }
        .labelActive{
            border: 1px solid #D15600;
            border-radius: 4px;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom: none;
            color:#D15600;
        }
        .m-sch {
            position: relative;
            color:#666;
            font-size: 13px;
            margin-left: 220px;
        }
        .m-sch .form,.m-sch .txt {
            width: 0;
            height: 22px;
            line-height: 22px;
        }
        .m-sch .form {
            position: absolute;
            left: 0;
            top: 0;
            padding: 0 10px;
            border: 1px solid #aaa;
            opacity: 0;
            visibility: hidden;
        }
        .m-sch .txt {
            border: 0;
            background: none;
        }
        .m-sch .form {
            border-color: #aaa;
        }
        a,.m-sch .form {
            -webkit-transition: all .3s ease;
            transition: all .3s ease;
            list-style: none;
            text-decoration: none;
            color:#666
        }
        .m-sch .form {
            -webkit-border-radius: 4px;
            -moz-border-radius: 4px;
           border-radius: 4px;
        }
        .m-schshow .form,.m-schshow .txt {
            width: 80px;
            outline: none;
        }
        .m-schshow .form {
            opacity: 1;
            visibility: visible;
        }
        .f-hidden {
            visibility: hidden;
        }
    </style>
</head>
<body>
<div id="navi-header" class="navi-header ">
	<div class="navi-inner">
		<div id="navi-logo" class="navi-logo">
             <a href="{{ url_for('index.show_network',username = session.username) }}">Tree Network</a>
		</div>

		<ul class="navi-entry">
            <li class="entry-home-li">

                <a href="##" class="entry-home">
					<span class="home-icon">
					</span>
					<span class="home-text">{{ session.username }}</span>
				</a>
			</li>
			<li class="entry-signout-li">
				<a href="{{ url_for("index.logout") }}" class="entry-signout">
					<span class="signout-icon"></span>
					<span class="signout-text">SignOut</span>
				</a>
			</li>
		</ul>

	</div>
</div>

<div class="changeIfmBox">
    <ul class="select__options Infbox">
        {% if  session.type %}
            <li><a href="{{ url_for('index.jump_admin_page') }}"><p>manage users</p></a></li>
        {% else %}
            <li><a href="{{ url_for('index.jump_change_pwd') }}"><p>change password</p></a></li>
            <li><a href="{{ url_for('index.jump_security_questions') }}"><p>change secure questions</p></a></li>
        {% endif %}
    </ul>
</div>

<div id="mynetwork" class="mywork"></div>
<div class="button-box">
    <div class="blockbox">
        <div class="select-container">
                <div class="select">
                     <i  name="select-btn" style="float:right;margin-top: 5px;margin-right: 2px;font-size: 20px;cursor: pointer;color:#555;" class="material-icons" onselectstart="return false;">add</i>
                    <input readonly="value" class="form-control post-question" id="connectorSelectBox" type="text"  style="border: 0;">
                     <ul class="select__options">
                    </ul>
                </div>
    	</div>
        <div class="select-container">
                <div class="select">
                     <i  name="select-btn3" style="float:right;margin-top: 5px;margin-right: 2px;font-size: 20px;cursor: pointer;color:#555;" class="material-icons" onselectstart="return false;">add</i>
                    <input readonly="value" class="form-control post-question" id="connectorSelectBox2" type="text"  style="border: 0;">
                     <ul class="select__options">
                    </ul>
                </div>
    	</div>
         <button  type="submit" name="richtext-submit" class="btn btn-primary addConnectorNodeBtn" style="font-size: 14px;">Add Pattern</button>
    </div>
    <div class="blockbox">
        <div class="select-container">
            <div class="select">
                 <i  name="select-btn" style="float:right;margin-top: 5px;margin-right: 2px;font-size: 20px;cursor: pointer;color:#555;" class="material-icons" onselectstart="return false;">add</i>
                <input readonly="value" class="form-control post-question" id="deleteConnector" type="text"  style="border: 0;">
                 <ul class="select__options">
                </ul>
            </div>
    	</div>
        <button  type="submit" name="richtext-submit" class="btn btn-primary deleteConnNodeBtn" style="font-size: 14px;">Delete Pattern</button>
    </div>
    <div class="blockbox">
        <div class="select-container">
                <div class="select">
                     <i  name="select-btn2" style="float:right;margin-top: 5px;margin-right: 2px;font-size: 20px;cursor: pointer;color:#555;" class="material-icons" onselectstart="return false;">add</i>
                    <input readonly="value" class="form-control post-question" id="domainSelect" type="text"  style="border: 0;">
                     <ul class="select__options">
                    </ul>
                </div>
    	</div>
         <button  type="submit" name="richtext-submit" class="btn btn-primary2 addDomainBtn" style="font-size: 14px;">Add Domain</button>
    </div>
    <div class="blockbox">
        <div class="select-container">
                <div class="select">
                     <i  name="select-btn" style="float:right;margin-top: 5px;margin-right: 2px;font-size: 20px;cursor: pointer;color:#555;" class="material-icons" onselectstart="return false;">add</i>
                    <input readonly="value" class="form-control post-question" id="addEdgeSelectBox" type="text"  style="border: 0;">
                     <ul class="select__options">
                    </ul>
                </div>
    	</div>
        <div class="select-container">
                <div class="select">
                     <i  name="select-btn" style="float:right;margin-top: 5px;margin-right: 2px;font-size: 20px;cursor: pointer;color:#555;" class="material-icons" onselectstart="return false;">add</i>
                    <input readonly="value" class="form-control post-question" id="addEdgeSelectBox2" type="text"  style="border: 0;">
                     <ul class="select__options">
                    </ul>
                </div>
    	</div>
         <button  type="submit" name="richtext-submit" class="btn btn-primary addEdgeBtn" style="font-size: 12px;">Add Connection</button>
    </div>
    <div class="blockbox">
        <button  type="submit" name="richtext-submit" class="btn btn-primary2 delEdgeBtn" style="font-size: 10px;">Delete Connection</button>
    </div>
</div>

<div class="button-box2">
    <div class="blockbox">
        <div class="btnBox">
             <div class="select-container bottom-container">
                <div class="select">
                     <i  name="select-btn" style="float:right;margin-top: 5px;margin-right: 2px;font-size: 20px;cursor: pointer;color:#555;" class="material-icons" onselectstart="return false;">add</i>
                    <input readonly="value" class="form-control post-question " id="messageFrom" type="text"  style="border: 0;">
                     <ul class="select__options">
                    </ul>
                </div>
            </div>
            <div class="select-container bottom-container ">
                    <div class="select">
                         <i  name="select-btn" style="float:right;margin-top: 5px;margin-right: 2px;font-size: 20px;cursor: pointer;color:#555;" class="material-icons" onselectstart="return false;">add</i>
                        <input readonly="value" class="form-control post-question" id="messageTo" type="text"  style="border: 0;">
                         <ul class="select__options">
                        </ul>
                    </div>
            </div>
            <textarea  id="messageInf" cols="30" rows="10" class="messageInf" ></textarea>
            <button  type="submit" name="richtext-submit" class="btn btn-primary sendMessageBtn" style="font-size: 13px;">Send message</button>
        </div>
        <div class="btnBox">
            <button  type="text" name="richtext-submit" class="btn btn-primary messageBoxBtn" style="font-size: 13px;">Message Box</button>
            <button  type="text" name="richtext-submit" class="btn btn-primary2 activateNodeBtn" style="font-size: 14px;">Activate</button>
            <button  type="submit" name="richtext-submit" class="btn btn-primary2 addNormalNodeBtn" style="font-size: 14px;">Add Node</button>
            <button  type="submit" name="richtext-submit" class="btn btn-primary2 deleteNormalNodeBtn" style="font-size: 14px;">Delete Node</button>
            <input id="defaultSlider" type="range" min="0" max="100" value="0"/>
        </div>
    </div>
    <div class="wordbox">
        <span class="lastword">last word: 50</span>
    </div>
</div>
<div class="cover-black hideblock"></div>
<div class="messageBoxBlock">
    <label for="messageBox" id="messagaBoxLab">Message Box</label>
    <div class="controler">
        <label for="success" id="successBtn" class="labelActive">Delivered Message</label>
        <label for="fail" id="failBtn">Blocked Message</label>
        <label for="search" class="m-sch">
            <a id="j-lnksch" href="##">Search</a>
                <div id="j-schform" class="form">
                    <input type="text" name="searchBox" class="txt" placeholder="keyword">
                </div>
        </label>
    </div>
    <div class="messageBox">
        <ul class="messageList select__options">
        </ul>
    </div>
    <div class="closeBox">
        <button  type="text" name="richtext-submit" class="btn btn-primary closeMsgBtn" style="font-size: 15px;">Close</button>
    </div>
</div>

<script type="text/javascript">
    var prev_data = null,
    waiting_for_update = false,
    LONG_POLL_DURATION = 60000;
    var pool_stop = false;
    var $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
    var networkPY;
    var networkTest;
    var dataStore;
    var msgLock = false;
    var msgboxList;
    var msgboxList2;
    var options={
        nodes:{
            mass:0,
            size:10,
            scaling:{
                min:10,
                max:10,
                label:{
                    enabled:true,
                    min:10,
                    max:10
                }
            },
            value: 10,
            fixed: true,
            shapeProperties:{
                borderRadius: 1
            }
        },
        edges:{
        },
        physics:{
            enabled:false,
            stabilization:false
        },
        layout:{
            improvedLayout:false
        },
        interaction:{
            zoomView: false,
            selectConnectedEdges:false
        }
    };
    var container = document.getElementById('mynetwork');

    $('[name=select-btn]').click(function() {
        $(this).parent().parent().toggleClass('select-is-open');
    });
    $('[name=select-btn2]').click(function() {
        if($(this).parent().parent().hasClass('select-is-open')){
            var count = 8;
            if($(this).next().prop('id')=="domainSelect") count=6;
            var val = "";
            $(this).parent().find('.select__options li').find('label').each(function(){
                if($(this).prev().prop('checked')){
                    if(val!="") val = val + ","+ $(this).text().substring(count);
                    else val = val + $(this).text().substring(count);
                }
            });
            var btn = $(this).parent().parent().parent().find('button');
            if(val!=""||(val==""&&$(this).parent().find('.select__options li').length==0)){
                btn.removeClass('btn-primary2');
                btn.addClass('btn-primary');
            }
            else{
                btn.removeClass('btn-primary');
                btn.addClass('btn-primary2');
            }
            $(this).next().val(val);
        }
        $(this).parent().parent().toggleClass('select-is-open');
    });
    $('[name=select-btn3]').click(function() {
        if($(this).parent().parent().hasClass('select-is-open')){
            var count = 8;
            if($(this).next().prop('id')=="domainSelect") count=6;
            var val = "";
            $(this).parent().find('.select__options li').find('label').each(function(){
                if($(this).prev().prop('checked')){
                    if(val!="") val = val + ","+ $(this).text().substring(count);
                    else val = val + $(this).text().substring(count);
                }
            });
            var btn = $(this).parent().parent().parent().find('button');

            $(this).next().val(val);
        }
        $(this).parent().parent().toggleClass('select-is-open');
    });

    $('[name=searchBox]').bind('keypress',function(event){
            if(event.keyCode == "13") {
                var value = parseInt($(this).val());
                var returnList = [];
                if($('#successBtn').hasClass('labelActive')){
                    if(!value||$(this).val()==""){
                        returnList = msgboxList;
                    }
                    else{
                        for(var i in msgboxList){
                            if(msgboxList[i].to==value){
                                returnList.push(msgboxList[i]);
                            }
                        }
                    }
                    console.log(returnList);
                    $('.messageList').find('li').each(function(){
                        $(this).remove();
                    });
                    for(var i in returnList){
                        $('.messageList').append("<li><span class='Msgfrom Msglabel'>From: <label for='from'>" +returnList[i].from
                                    +"</label> </span> <span class='Msgto Msglabel'>To: <label for='to'>" + returnList[i].to +
                                    "</label> </span><span class='Msgcontent'>"+returnList[i].msg +"</span> <span class='Msgtime Msglabel'>"+ returnList[i].ctime
                                        + "</span></li> ");
                    }
                }
                else{
                    if(!value||$(this).val()==""){
                        returnList = msgboxList2;
                    }
                    else{
                        for(var i in msgboxList2){
                            if(msgboxList2[i].blocked==value){
                                returnList.push(msgboxList2[i]);
                            }
                        }
                    }
                    console.log(returnList);
                    $('.messageList').find('li').each(function(){
                        $(this).remove();
                    });
                    for (var i in returnList){
                        $('.messageList').append("<li><span class='Msgfrom Msglabel'>Sender: <label for='sender'>" +returnList[i].sender
                            +"</label> </span> <span class='Msgto Msglabel'>To: <label for='to'>" + returnList[i].to +
                            "</label> </span> <span class='Msgblock Msglabel'>Block: <label for='block'>" +returnList[i].blocked
                                + "</label> </span> <span class='Msgcontent'>"+returnList[i].msg +"</span>");
                    }
                }
            }
        });

    $('#successBtn').click(function(){
        $('#failBtn').removeClass('labelActive');
        $(this).addClass('labelActive');
         $('.messageList').find('li').each(function(){
            $(this).remove();
        });
        for (var i in msgboxList){
            $('.messageList').append("<li><span class='Msgfrom Msglabel'>From: <label for='from'>" +msgboxList[i].from
                +"</label> </span> <span class='Msgto Msglabel'>To: <label for='to'>" + msgboxList[i].to +
                "</label> </span><span class='Msgcontent'>"+msgboxList[i].msg +"</span> <span class='Msgtime Msglabel'>"+ msgboxList[i].ctime
                    + "</span></li> ");
        }
    });

    $('#failBtn').click(function(){
        $('#successBtn').removeClass('labelActive');
        $(this).addClass('labelActive');
         $('.messageList').find('li').each(function(){
            $(this).remove();
        });
        console.log(msgboxList2);
        for (var i in msgboxList2){
            $('.messageList').append("<li><span class='Msgfrom Msglabel'>Sender: <label for='sender'>" +msgboxList2[i].sender
                +"</label> </span> <span class='Msgto Msglabel'>To: <label for='to'>" + msgboxList2[i].to +
                "</label> </span> <span class='Msgblock Msglabel'>Block: <label for='block'>" +msgboxList2[i].blocked
                    + "</label> </span> <span class='Msgcontent'>"+msgboxList2[i].msg +"</span>");
        }
    });

    $('.home-text').click(function(){
        $('.changeIfmBox').toggleClass('select-is-open');
    });

    function bindSchEvents($lnk, $txt){
        $lnk.bind('click', function (){
            $(this).addClass('f-hidden').parent().addClass('m-schshow');
            setTimeout(function (){
                $txt.focus();
            }, 300);
            return false;
        });
        $txt.bind('blur', function (){
            setTimeout(function (){
                $lnk.removeClass('f-hidden').parent().removeClass('m-schshow');
            }, 300);
            return false;
        });
    }


    $('.activateNodeBtn').bind('click',function(){
        if($(this).hasClass('btn-primary')){
            if(networkTest.getSelectedNodes().length==0) return false;
            var node= networkTest.getSelectedNodes()[0];
            console.log(node);
            networkPY.Activate(node);
            $.getJSON($SCRIPT_ROOT + '/network/activeNode', {
                a: node
              }, function(data) {
                $('.activateNodeBtn').removeClass('btn-primary');
                $('.activateNodeBtn').addClass('btn-primary2');
               var msgL = JSON.parse(data.result);
                console.log(data.result);
                var msgList = [];
                for(var i in msgL){
                    msgList.push(new NetworkYun.Message(msgL[i]));
                }
                console.log(msgList);
                var path_cpy=0;
                for(var i in msgList){
{#                    $.getJSON($SCRIPT_ROOT + '/message/sendMessage', {#}
{#                        a: msgList[i].from,#}
{#                        b: msgList[i].to,#}
{#                        c: msgList[i].msg,#}
{#                        d: msgList[i].msgId#}
{#                      }, function(data) {#}
{#                            var path = JSON.parse(data.result);#}
{#                            console.log(path);#}
{#                            var count = data.count;#}
{#                            networkPY.toggleColor(path,count);#}
{#                            changeSelectBox();#}
{#                      });#}
                        $.ajax({
                         url:$SCRIPT_ROOT + '/message/sendMessage',
                         data:{
                             a: msgList[i].from,
                             b: msgList[i].to,
                             c: msgList[i].msg,
                             d: msgList[i].msgId
                         },
                         async:false,
                         dataType: "json",
                         success:function(data){
                             var path = JSON.parse(data.result);
                             var count = data.count;
                             setTimeout(function(){
                                 networkPY.toggleColor(path,count);
                             },path_cpy);
                             path_cpy += (path.length+2)*1000;
                             changeSelectBox();
                         }
                     });
                }
              });
        }
    });

    function  judgeSelect(){
            var nodes = networkTest.getSelectedNodes();
            if(nodes.length==0){
                $('.addNormalNodeBtn').removeClass('btn-primary');
                $('.addNormalNodeBtn').addClass('btn-primary2');
                $('.deleteNormalNodeBtn').removeClass('btn-primary');
                $('.deleteNormalNodeBtn').addClass('btn-primary2');
            }
            else{
                var node = nodes[0];
                if(networkPY.getCanBeAdded(node)!=-1){
                    $('.addNormalNodeBtn').removeClass('btn-primary2');
                    $('.addNormalNodeBtn').addClass('btn-primary');
                }
                else{
                    $('.addNormalNodeBtn').removeClass('btn-primary');
                    $('.addNormalNodeBtn').addClass('btn-primary2');
                }
                if(networkPY.getCanBeDeleted(node)==1){
                    $('.deleteNormalNodeBtn').removeClass('btn-primary2');
                    $('.deleteNormalNodeBtn').addClass('btn-primary');
                }
                else{
                    $('.deleteNormalNodeBtn').removeClass('btn-primary');
                    $('.deleteNormalNodeBtn').addClass('btn-primary2');
                }
            }
            var edges = networkTest.getSelectedEdges();
            if(edges.length==0){
                $('.delEdgeBtn').removeClass('btn-primary');
                $('.delEdgeBtn').addClass('btn-primary2');
            }
            else{
                var edge = edges[0];
                if(networkPY.judgeEdgeToDel(edge)){
                    $('.delEdgeBtn').removeClass('btn-primary2');
                    $('.delEdgeBtn').addClass('btn-primary');
                }
                else{
                    $('.delEdgeBtn').removeClass('btn-primary');
                    $('.delEdgeBtn').addClass('btn-primary2');
                }
            }
    }

    function startNetwork(data){
        networkPY= new NetworkYun.Network(JSON.parse(data.result1));
        var nodesDataGet= networkPY.getNodesData();
        var edgesDataGet = networkPY.getEdgesData();
        var nodes2TT = new vis.DataSet();
        var edges2TT = new vis.DataSet();
         nodes2TT.add(nodesDataGet);
        edges2TT.add(edgesDataGet);
         dataStore={
            nodes : nodes2TT,
            edges : edges2TT
         };
        networkTest = new vis.Network(container, dataStore,options);
        changeSelectBox();
        console.log(networkPY);
{#        networkTest.on("click", function (params) {#}
{#            params.event = "[original event]";#}
{#            document.getElementById('eventSpan').innerHTML = '<h2>Click event:</h2>' + JSON.stringify(params, null, 4);#}
{#        });#}
        networkTest.on("selectNode", function (params) {
            if(params.nodes.length!=1) return false;
            var node = params.nodes[0];
            if(networkPY.getNodeById(node).getActive()==0){
                $('.activateNodeBtn').removeClass('btn-primary2');
                $('.activateNodeBtn').addClass('btn-primary');
            }
            else{
                $('.activateNodeBtn').removeClass('btn-primary');
                $('.activateNodeBtn').addClass('btn-primary2');
            }
            judgeSelect();
        });
        networkTest.on("deselectNode", function (params) {
            judgeSelect();
        });
        networkTest.on("selectEdge", function (params) {
            if(params.edges.length!=1) return false;
            judgeSelect();
        });
        networkTest.on("deselectEdge", function (params) {
            $('.delEdgeBtn').removeClass('btn-primary');
            $('.delEdgeBtn').addClass('btn-primary2');
        });
    }

   function  makeSelectBox1(whichBox,dataF,f){
        whichBox.next().children().each(function(){
                $(this).remove();
        });
        for(var i=0;i<dataF.length;i++){
            whichBox.next().append("<li><input name='checkOrNot' type='checkbox'>" +
                    "<label class='checkOrNotLabel' for='checkOrNot'>" +dataF[i] +"</label></li>");
        }
        if(whichBox.parent().find('.select__options li').length==0){
                whichBox.val("Nothing");
        }
        else{
            whichBox.parent().find('.select__options li').find('label').bind('click',function(){
                if($(this).prev().prop('checked')) $(this).prev().prop('checked',false);
                else  $(this).prev().prop('checked',true);
            });
        }
    }



    function  makeSelectBox2(whichBox,dataF,f,f2){
        whichBox.next().children().each(function(){
                $(this).remove();
        });
        for(var i=0;i<dataF.length;i++){
            whichBox.next().append("<li ><p>" +dataF[i] +"</p></li>");
        }
        var btn =whichBox.parent().parent().parent().find('button');
        if(whichBox.parent().find('.select__options li').length==0){
                whichBox.val("Nothing");
                btn.removeClass('btn-primary');
                btn.addClass('btn-primary2');
                f2();
        }
        else{
            btn.removeClass('btn-primary2');
            btn.addClass('btn-primary');
            whichBox.parent().find('.select__options li').bind('click',function(){
                whichBox.val($(this).find('p').text());
                $(this).parent().parent().parent().removeClass('select-is-open');
                f();
            });
            var checkOrNot = false;
            whichBox.parent().find('.select__options li').each(function(){
               if($(this).find('p').text()==whichBox.val()){
                   checkOrNot = true;
                   $(this).click();
               }
            });
            if(!checkOrNot){
                whichBox.parent().find('.select__options li:nth-child(1)').click();
            }
        }
    }


    function  changeSelectBox(){
        $('.blockbox li').each(function(){
            $(this).remove();
        });
        $('#connectorSelectBox2').val("");
        $('#domainSelect').val("");
        for(var i=0;i<networkPY.domains.length;i++){
             $('#domainSelect').next().append("<li><input name='checkOrNot' type='checkbox'>" +
                             "<label class='checkOrNotLabel' for='checkOrNot'>domain " + networkPY.domains[i].domainId + "</label></li>");
        }
        var btn =$('.addDomainBtn');
        if($('#domainSelect').parent().find('.select__options li').length==0){
            btn.removeClass('btn-primary2');
            btn.addClass('btn-primary');
        }
        else{
            btn.removeClass('btn-primary');
            btn.addClass('btn-primary2');
        }
        $('#domainSelect').parent().find('.select__options li').find('label').bind('click',function(){
           if($(this).prev().prop('checked')) $(this).prev().prop('checked',false);
           else  $(this).prev().prop('checked',true);
        });
        //$('#normalSelect2').parent().parent().addClass('hideblock');
        //$('#deleteSelect2').parent().parent().addClass('hideblock');

{#        makeSelectBox2($('#normalSelect'),networkPY.getPatNodeBeAdded(),#}
{#            function(){#}
{#                $('#normalSelect2').parent().parent().removeClass('hideblock');#}
{#                makeSelectBox2($('#normalSelect2'),networkPY.getCanBeAddedNode($('#normalSelect').val().substring(8)),function(){});#}
{#            }#}
{#        );#}
{#        makeSelectBox2($('#deleteSelect'),networkPY.getPatNodeBeDel(),#}
{#            function(){#}
{#                $('#deleteSelect2').parent().parent().removeClass('hideblock');#}
{#                makeSelectBox2($('#deleteSelect2'),networkPY.getCanBeDeletedNode($('#deleteSelect').val().substring(8)),function(){});#}
{#            }#}
{#        );#}
        $('#connectorSelectBox2').parent().parent().addClass('hideblock');
        makeSelectBox2($('#connectorSelectBox'),networkPY.getAllDomainId(),function(){
            $('#connectorSelectBox2').parent().parent().removeClass('hideblock');
            makeSelectBox1($('#connectorSelectBox2'),networkPY.getAllPatInDomain($('#connectorSelectBox').val().substring(6)),
                    function(){});
        },function(){
            $('#connectorSelectBox2').val('');
            $('#connectorSelectBox2').parent().parent().addClass('hideblock');
        });
        makeSelectBox2($('#addEdgeSelectBox'),networkPY.getaddEdgeData(),function(){
            $('#addEdgeSelectBox2').parent().parent().removeClass('hideblock');
            makeSelectBox2($('#addEdgeSelectBox2'),networkPY.getaddEdgeData2(parseInt($('#addEdgeSelectBox').val().substring(5))),
                    function(){});
        },function(){
            $('#addEdgeSelectBox2').val('');
            $('#addEdgeSelectBox2').parent().parent().addClass('hideblock');
        });
        makeSelectBox2($('#deleteConnector'),networkPY.getCanBeDelPattern2(),function(){},function(){});
        makeSelectBox2($('#messageFrom'),networkPY.getAllNodeId(),function(){
            if($('#messageTo').val()==$('#messageFrom').val()) $('#messageTo').val("");
        });
        makeSelectBox2($('#messageTo'),networkPY.getAllNodeId(),function(){
            if($('#messageTo').val()==$('#messageFrom').val()) $('#messageFrom').val("");
        });
        $('#messageFrom').val("");
        $('#messageTo').val("");
    }


     $('.addConnectorNodeBtn').click(function () {
         if($(this).hasClass('btn-primary2')) return false;
         var patternBoxs=[];
         var whichDomain = $('#connectorSelectBox').val().substring(6);
        $('#connectorSelectBox2').next().find('input').each(function(){
            if($(this).is(':checked')) patternBoxs.push(parseInt($(this).next().text().substring(8)));
        });
{#         if(patternBoxs.length==0){#}
{#             if($('#connectorSelectBox2').next().find('input').length!=0) return false;#}
{#         }#}
         var whichNode = networkPY.ToBeAddedOnePattern();
         $.getJSON($SCRIPT_ROOT + '/network/addPattern', {
                    a: JSON.stringify(patternBoxs),
                    b: parseInt(whichDomain)
                  }, function(data) {
                        var count1 = data.result1;
                        var count2 = data.result2;
                        whichNode.pid = count1;
                        whichNode.nid = count2;
                        networkPY.addPattern(whichNode,patternBoxs,parseInt(whichDomain));
                        changeSelectBox();
                         $.getJSON($SCRIPT_ROOT + '/network/whole_network', {
                                a: 1
                              }, function(data) {
                                    startNetwork(data);
                              });
                  });

     });

    $('.addDomainBtn').click(function () {
        if($(this).hasClass('btn-primary2')) return false;
         var patternBoxs=[];
        $('#domainSelect').next().find('input').each(function(){
            if($(this).is(':checked')) patternBoxs.push(parseInt($(this).next().text().substring(6)));
        });
         if(patternBoxs.length==0){
             if($('#domainSelect').next().find('input').length!=0) return false;
         }
         var whichNode = networkPY.ToBeAddedOnePattern();
         $.getJSON($SCRIPT_ROOT + '/network/addDomain', {
                    a: JSON.stringify(patternBoxs),
                  }, function(data) {
                        var count1 = data.result1;
                        var count2 = data.result2;
                        var domainID = data.result3;
                        var domainNodeId = data.result4;
                        whichNode.pid = count1;
                        whichNode.nid = count2;
                        var whichNode2 = networkPY.exDomainNode();
                        whichNode2.nid = domainNodeId;
                        networkPY.newDomain(whichNode,domainID,whichNode2,patternBoxs);
                        changeSelectBox();
             $.getJSON($SCRIPT_ROOT + '/network/whole_network', {
                                a: 1
                              }, function(data) {
                                    startNetwork(data);
                              });
                  });
     });

    $('.addNormalNodeBtn').click(function () {
        if(networkTest.getSelectedNodes().length==0) return false;
        if($(this).hasClass('btn-primary2')) return false;
        var whichParent = networkTest.getSelectedNodes()[0];
        var whichPatternId = networkPY.getNodeById(whichParent).getPatternId();
        var whichNode = networkPY.ToBeAddedOne(whichParent);
        if(!whichNode) return false;
        $.getJSON($SCRIPT_ROOT + '/network/addNode', {
                    a: JSON.stringify(whichNode)
                  }, function(data) {
                        var i = data.result1;
                        whichNode.nid=i;
                        networkPY.addNode(whichPatternId,whichNode);
                        changeSelectBox();
                        judgeSelect();
                  });
    });

     $('.deleteNormalNodeBtn').click(function(){
         if(networkTest.getSelectedNodes().length==0) return false;
         if($(this).hasClass('btn-primary2')) return false;
         var whichOne = networkTest.getSelectedNodes()[0];
         var returnList = networkPY.deleteNode(whichOne);
         $.getJSON($SCRIPT_ROOT + '/network/deleteNode', {
                    a: JSON.stringify(returnList)
                  }, function(data) {
                        var i = data.result1;
                        changeSelectBox();
                        judgeSelect();
                  });
     });

     $('.deleteConnNodeBtn').click(function(){
         if($(this).hasClass('btn-primary2')) return false;
         if($('#deleteConnector').val()=="Nothing"||$('#deleteConnector').val()=="") return false;
         var whichPatternId =  $('#deleteConnector').val().substring(8);
         var returnList;
         if(networkPY.getDomainById(networkPY.getPatternById(whichPatternId).getDomainId()).patterns.length==1){
             returnList = networkPY.deletePatternLast(whichPatternId);
         }
         else {
             returnList = networkPY.deletePattern(whichPatternId);
         }
         $.getJSON($SCRIPT_ROOT + '/network/deletePattern', {
                    a: JSON.stringify(returnList.nodeId)
                  }, function(data) {
                        changeSelectBox();
                        judgeSelect();
                  });
     });


    $('.addEdgeBtn').click(function(){
        if($(this).hasClass('btn-primary2')) return false;
        var node1 =  $('#addEdgeSelectBox').val().substring(5);
        var node2 =  $('#addEdgeSelectBox2').val().substring(5);
        $.getJSON($SCRIPT_ROOT + '/network/addConnection', {
                    a:node1,
                    b:node2
                  }, function(data) {
                        networkPY.addEdge(parseInt(node1),parseInt(node2));
                        changeSelectBox();
                        judgeSelect();
                  });
    });

    $('.delEdgeBtn').click(function(){
        if($(this).hasClass('btn-primary2')) return false;
        var edgeId =  networkTest.getSelectedEdges()[0];
        var edge =networkPY.getEdgeById(edgeId);
        $.getJSON($SCRIPT_ROOT + '/network/deleteConnection', {
                    a:edge.getFrom(),
                    b:edge.getTo()
                  }, function(data) {
                        networkPY.deleteEdge(edge.getId());
                        changeSelectBox();
                        judgeSelect();
                  });
    });


    $('.sendMessageBtn').click(function(){
        if($('#messageFrom').val()==""||$('#messageTo').val()==""||$('.messageInf').val()=="") return false;
         $.getJSON($SCRIPT_ROOT + '/message/sendMessage', {
                    a: parseInt($('#messageFrom').val().substring(5)),
                    b: parseInt($('#messageTo').val().substring(5)),
                    c: $('.messageInf').val(),
                    d: -1
                  }, function(data) {
                        var path = JSON.parse(data.result);
                        var count = data.count;
                        networkPY.toggleColor(path,count);
                        changeSelectBox();
                  });
    });

    $('.closeMsgBtn').click(function(){
        $(".cover-black").addClass('hideblock');
        $('.messageBoxBlock').removeClass('messageBox-show');
    });

    $('.messageInf').keyup(function(){
        if($(this).val().length>50){
            $(this).val($(this).val().substring(0,50));
            $('.lastword').text("last word: 0");
        }
        else $('.lastword').text("last word: "+String(50-$(this).val().length));
    });

    $('.messageInf').keydown(function(){
        if($(this).val().length>50){
            $(this).val($(this).val().substring(0,50));
            $('.lastword').text("last word: 0");
        }
        else $('.lastword').text("last word: "+String(50-$(this).val().length));
    });

    $('.messageBoxBtn').click(function(){
         $(".cover-black").removeClass('hideblock');
        $('.messageBoxBlock').addClass('messageBox-show');
        $('.messageList').find('li').each(function(){
            $(this).remove();
        });
        $.getJSON($SCRIPT_ROOT + '/message/wholeMessages', {
                    a: 1
                  }, function(data) {
                        var msgL = JSON.parse(data.result1);
                        var fmsgL = JSON.parse(data.result2);
                        msgboxList = [];
                        msgboxList2 = [];
                        for(var i in msgL){
                            msgboxList.push(new NetworkYun.Message(msgL[i]));
                        }
                        for(var i in fmsgL){
                            msgboxList2.push(new NetworkYun.Message(fmsgL[i]));
                        }
                        $('#successBtn').click();
                  });
    });

    $('#defaultSlider').change(function(){
        $.getJSON($SCRIPT_ROOT + '/changeRand', {
            a:$('#defaultSlider').val()
        }, function(data){
            if(parseInt($('#defaultSlider').val())>0){
                pool_stop=false;
                load_data();
                console.log('hello');
            }
            else pool_stop = true;
        });
    });


    function load_data() {
        $.ajax({ url:$SCRIPT_ROOT+ '/data',
                 success: function(data) {
                      networkPY.Inactive(JSON.parse(data.result1));
                      if(networkTest.getSelectedNodes().length>0){
                          if(networkPY.getNodeById(networkTest.getSelectedNodes()[0]).getActive()==0){
                            $('.activateNodeBtn').removeClass('btn-primary2');
                            $('.activateNodeBtn').addClass('btn-primary');
                          }
                          else{
                              $('.activateNodeBtn').removeClass('btn-primary');
                              $('.activateNodeBtn').addClass('btn-primary2');
                          }
                      }
                      wait_for_update();
                  }
        });
        return true;
    }

    function wait_for_update() {
        if (!waiting_for_update&&!pool_stop) {
            console.log('test');
            waiting_for_update = true;
            $.ajax({ url: '/updated',
                     success:  load_data,
                     complete: function () {
                        waiting_for_update = false;
                        wait_for_update();
                     },
                     timeout:  LONG_POLL_DURATION
                   });
        }
    }


    $(document).ready(function($){
        $.getJSON($SCRIPT_ROOT + '/randomSpeed', {
                    a: 1
                  }, function(data) {
                    $('#defaultSlider').val(data.result1);
                  });
        setTimeout(function (){
            $.getJSON($SCRIPT_ROOT + '/network/whole_network', {
                    a: 1
                  }, function(data) {
                        startNetwork(data);
                        if(parseInt($('#defaultSlider').val())>0){
                            pool_stop=false;
                            load_data();
                            console.log('hello');
                        }
                        else pool_stop=true;
                  });
            }, 100);
        bindSchEvents($('#j-lnksch'), $('#j-schform .txt'));
    });

     function sendJson(one,two,count){
         var checkOrNot = false;
         $.ajax({
             url:$SCRIPT_ROOT + '/message/verifyNode',
             data:{
                 a:one,
                 b:two,
                 c:count
             },
             async:false,
             dataType: "json",
             success:function(data){
                 if(data.result == 1) checkOrNot=true;
                 else checkOrNot=false;
             }
         });
        if(checkOrNot) return true;
        else return false;
    }

</script>
</body>
</html>
